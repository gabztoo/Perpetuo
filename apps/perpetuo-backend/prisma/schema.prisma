generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== USERS =====
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  workspaces    Workspace[]
  provider_keys ProviderKey[]
  api_keys      APIKey[]
  logs          RequestLog[]

  @@index([email])
}

// ===== WORKSPACES =====
model Workspace {
  id            String    @id @default(cuid())
  name          String
  user_id       String
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  user          User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  provider_keys ProviderKey[]
  api_keys      APIKey[]
  logs          RequestLog[]
  usage_counter UsageCounter?

  @@index([user_id])
}

// ===== PROVIDER KEYS (BYOK - Bring Your Own Keys) =====
model ProviderKey {
  id            String    @id @default(cuid())
  workspace_id  String
  provider      String    // "openai", "anthropic", "google", etc
  api_key       String    // encrypted
  priority      Int       @default(1) // 1 = highest priority for fallback
  enabled       Boolean   @default(true)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  workspace     Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id       String

  @@index([workspace_id])
  @@index([user_id])
  @@unique([workspace_id, provider]) // one primary key per provider per workspace
}

// ===== API KEYS (PERPETUO_KEY for client apps) =====
model APIKey {
  id            String    @id @default(cuid())
  workspace_id  String
  key           String    @unique // "pk_xxxxx..."
  name          String
  active        Boolean   @default(true)
  last_used     DateTime?
  created_at    DateTime  @default(now())
  revoked_at    DateTime?

  workspace     Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id       String

  @@index([workspace_id])
  @@index([key])
}

// ===== REQUEST LOGS =====
model RequestLog {
  id              String    @id @default(cuid())
  workspace_id    String
  api_key_id      String
  provider_used   String    // which provider handled this request
  model           String
  status_code     Int
  input_tokens    Int       @default(0)
  output_tokens   Int       @default(0)
  error_message   String?
  duration_ms     Int       @default(0)
  created_at      DateTime  @default(now())

  workspace       Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id         String

  @@index([workspace_id])
  @@index([api_key_id])
  @@index([created_at])
  @@index([provider_used])
}

// ===== USAGE COUNTER (for analytics) =====
model UsageCounter {
  id            String    @id @default(cuid())
  workspace_id  String    @unique
  total_requests Int      @default(0)
  total_input_tokens Int  @default(0)
  total_output_tokens Int @default(0)
  period_start  DateTime  @default(now())
  period_end    DateTime?
  updated_at    DateTime  @updatedAt

  workspace     Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([workspace_id])
}
